name: Pluggy OFX Export Sync

on:
  schedule:
    # Run daily at 2am UTC
    - cron: '0 2 * * *'
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Run sync
        id: sync
        env:
          PLUGGY_CLIENT_ID: ${{ secrets.PLUGGY_CLIENT_ID }}
          PLUGGY_CLIENT_SECRET: ${{ secrets.PLUGGY_CLIENT_SECRET }}
          PLUGGY_ITEM_IDS: ${{ secrets.PLUGGY_ITEM_IDS }}
          YNAB_API_KEY: ${{ secrets.YNAB_API_KEY }}
          ACCOUNT_CONFIG: ${{ secrets.ACCOUNT_CONFIG }}
        run: |
          pnpm export-ofx sync 2>&1 | tee sync_output.txt

      - name: Generate summary report
        if: always()
        run: |
          # Extract JSON between markers
          if grep -q "::SYNC_SUMMARY_START::" sync_output.txt; then
            sed -n '/::SYNC_SUMMARY_START::/,/::SYNC_SUMMARY_END::/p' sync_output.txt | grep -v '::SYNC_SUMMARY' > summary.json
            
            # Parse and generate markdown
            node -e "
            const fs = require('fs');
            const summary = JSON.parse(fs.readFileSync('summary.json', 'utf8'));
            
            let md = '# üìä Sync Report\n\n';
            md += '**Run Time:** ' + new Date(summary.timestamp).toLocaleString() + '\n';
            md += '**Date Range:** ' + summary.dateRange.from + ' to ' + summary.dateRange.to + '\n\n';
            
            md += '## Summary\n';
            md += '| Metric | Count |\n';
            md += '|--------|-------|\n';
            md += '| Accounts Processed | ' + summary.totalAccounts + ' |\n';
            md += '| Transactions Found (from Pluggy) | ' + summary.totalTransactionsFound + ' |\n';
            md += '| Already in YNAB (skipped) | ' + summary.totalAlreadyInYnab + ' |\n';
            md += '| Sent to YNAB | ' + summary.totalSentToYnab + ' |\n';
            md += '| Rejected by YNAB (duplicates) | ' + summary.totalRejectedByYnab + ' |\n';
            md += '| **Actually Created in YNAB** | **' + summary.totalActuallyCreated + '** |\n\n';
            
            md += '## Account Details\n\n';
            
            for (const result of summary.results) {
              const icon = result.status === 'success' ? '‚úÖ' : result.status === 'skipped' ? '‚è≠Ô∏è' : '‚ùå';
              md += '### ' + icon + ' ' + result.configName + '\n';
              md += '- **Account:** ' + result.accountName + ' (' + result.accountType + ')\n';
              md += '- **Status:** ' + result.status + '\n';
              md += '- **Transactions Found:** ' + result.transactionsFound + '\n';
              md += '- **Already in YNAB:** ' + result.alreadyInYnab + '\n';
              md += '- **Sent to YNAB:** ' + result.sentToYnab + '\n';
              md += '- **Rejected by YNAB:** ' + result.rejectedByYnab + '\n';
              md += '- **Actually Created:** ' + result.actuallyCreated + '\n';
              if (result.message) {
                md += '- **Note:** ' + result.message + '\n';
              }
              
              if (result.transactions && result.transactions.length > 0) {
                const created = result.transactions.filter(t => t.status === 'created');
                const duplicates = result.transactions.filter(t => t.status === 'duplicate');
                
                if (created.length > 0) {
                  md += '\n<details>\n<summary>‚úÖ View ' + created.length + ' CREATED transactions</summary>\n\n';
                  md += '| Date | Description | Amount |\n';
                  md += '|------|-------------|--------|\n';
                  for (const tx of created) {
                    const desc = (tx.description || '').substring(0, 40).replace(/\|/g, '-');
                    md += '| ' + tx.date + ' | ' + desc + ' | ' + tx.displayAmount + ' |\n';
                  }
                  md += '\n</details>\n';
                }
                
                if (duplicates.length > 0) {
                  md += '\n<details>\n<summary>‚ùå View ' + duplicates.length + ' REJECTED (duplicate) transactions</summary>\n\n';
                  md += '| Date | Description | Amount |\n';
                  md += '|------|-------------|--------|\n';
                  for (const tx of duplicates) {
                    const desc = (tx.description || '').substring(0, 40).replace(/\|/g, '-');
                    md += '| ' + tx.date + ' | ' + desc + ' | ' + tx.displayAmount + ' |\n';
                  }
                  md += '\n</details>\n';
                }
              }
              md += '\n';
            }
            
            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, md);
            "
          else
            echo "## ‚ö†Ô∏è Sync Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No summary data was generated. Check the logs for details." >> $GITHUB_STEP_SUMMARY
          fi
